package Logica;

import Dominio.Banco;
import Dominio.Cargo;
import Dominio.CentroCosto;
import Dominio.Codigo;
import Dominio.CodigoBcu;
import Dominio.CodigoDesvinc;
import Dominio.Declaracion;
import Dominio.Departamento;
import Dominio.EstadoCivil;
import Dominio.Fallecimiento;
import Dominio.Feriado;
import Dominio.Funcionario;
import Dominio.Horario;
import Dominio.Licencia;
import Dominio.LicenciaAdelantada;
import Dominio.MovimientoLicencia;
import Dominio.Parametro;
import Dominio.PersonasACargo;
import Dominio.Relacion;
import Dominio.Sns;
import Dominio.Sucursal;
import Persistencia.BDExcepcion;
import Persistencia.Conexion;
import Persistencia.PersistenciaCombos;
import Persistencia.PersistenciaFuncionario;
import Persistencia.PersistenciaHorario;
import java.sql.Connection;
import java.sql.SQLException;
import java.text.DecimalFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.Iterator;
import java.util.logging.Level;
import java.util.logging.Logger;


public class LogFuncionario {
    
    private PersistenciaFuncionario pers;
    private PersistenciaCombos c;
    private PersistenciaHorario hor;
    private ArrayList<Feriado> listaFeriados;
    private Conexion conexion;
    Connection cn;
    
    public LogFuncionario() throws ClassNotFoundException, SQLException {
        this.pers=new PersistenciaFuncionario();
        this.c=new PersistenciaCombos();
        this.hor= new PersistenciaHorario();
        this.listaFeriados=this.listarTodosFeriados();
    }

    public PersistenciaCombos getC() {
        return c;
    }

    public void setC(PersistenciaCombos c) {
        this.c = c;
    }
    public ArrayList<Sucursal> cargaComboSucursal() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboSucursal();
     }
     
     public ArrayList<Departamento> cargaComboDepto() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboDepto();
     }
     
     public ArrayList<CentroCosto> cargaComboCentro() throws SQLException, ClassNotFoundException{
         
         return c.cargaComboCentro();
     }
        public ArrayList<Cargo> cargaComboCargo() throws SQLException, ClassNotFoundException{
          
         return c.cargaComboCargo();
     }
     public ArrayList<Banco> cargaComboBanco() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboBanco();
     }
     public ArrayList<CodigoDesvinc> cargaComboCodigoDesvinc() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboCodigoDesvinc();
     }
     
     public CodigoDesvinc buscarCodigoDesvinc(Integer cod) throws SQLException, ClassNotFoundException{
        
         return c.buscarCodDes(cod);
     }
     public ArrayList<EstadoCivil> cargaComboEstado() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboEstadoCivil();
     }
     public ArrayList<Sns> cargaComboSns() throws SQLException, ClassNotFoundException{
        
         return c.cargaComboSns();
     }

    public Integer funcionarioExiste(Integer numFunc) throws SQLException, ClassNotFoundException {
       return pers.funcionarioExiste(numFunc);
    }

    public Boolean altaFuncionario(String numFunc, String apellidoUno, String apellidoDos, String nombreUno, String nombreDos, String direccion, String localidad, Departamento depto, String telefono, String celular, String cedula, String credencial, Date fechaNac, EstadoCivil estado, Character sexo, String iniciales, Date fechaIngreso, Cargo cargo, Date vigenciaCargo, Double sueldo, CentroCosto centro, String baseHoraria, String baseHoras, Sucursal sucursal, Sns sns, Banco banco, Double numeroCuenta, String cuenta, Integer afap, ArrayList<Horario> listaHorarios, Date vencimientoCarne) throws SQLException, ClassNotFoundException {
        Funcionario f=new Funcionario();
        Boolean alta=false;
       Integer num=Integer.valueOf(numFunc);
       Integer ced=Integer.valueOf(cedula);
       Integer horas=Integer.valueOf(baseHoras);
       Integer horaria=Integer.valueOf(baseHoraria);
       
           f.setCodFunc(num);
           f.setApellido1(apellidoUno);
           f.setApellido2(apellidoDos);
           f.setNombre1(nombreUno);
           f.setNombre2(nombreDos);
           f.setDireccion(direccion);
           f.setLocalidad(localidad);
           f.setDepartamento(depto);
           f.setTelefono(telefono);
           f.setCelular(celular);
           f.setCedula(ced);
           f.setCredencial(credencial);
           f.setFechaNac(fechaNac);
           f.setEstadoCivil(estado);
           f.setFechaIngreso(fechaIngreso);
           f.setSexo(sexo);
           f.setIniciales(iniciales);
           f.setCargo(cargo);
           f.setVigenciaCargo(vigenciaCargo);
           f.setSueldoCargo(sueldo);
           f.setCentroCosto(centro);
           f.setBaseHoraria(horaria);
           f.setBaseHoras(horas);
           f.setLugarTrabajo(sucursal);
           f.setSns(sns);
           f.setBanco(banco);
           f.setCuenta(numeroCuenta);
           f.setTipoCuenta(cuenta);
           f.setAfap(afap);
           f.setHorarios(listaHorarios);
           f.setVencimientoCarne(vencimientoCarne);
           alta=this.pers.altaFuncionario(f);
       
       return alta;
    }

    public Funcionario buscarFuncionario(String numFunc) throws ClassNotFoundException, SQLException {
        Integer codigo=Integer.valueOf(numFunc);
        Funcionario f=this.pers.buscarFuncionario(codigo);
        return f;
    }

    public boolean modFuncionario(Funcionario fv,String numFunc, String apellidoUno, String apellidoDos, String nombreUno, String nombreDos, String direccion, String localidad, Departamento depto, String telefono, String celular, String cedula, String credencial, Date fechaNac, EstadoCivil estado, Character sexo, String iniciales, Date fechaIngreso, Date fechaEgreso, Cargo cargo, Date vigenciaCargo, Double sueldo, CentroCosto centro, String baseHoraria, String baseHoras, Sucursal sucursal, Sns sns, Banco banco, Double numeroCuenta, String cuenta, Integer afap, ArrayList<Horario> listaHorarios, Date vencimientoCarne,CodigoDesvinc cod) throws SQLException {
       Funcionario f=new Funcionario();
       Boolean alta=false;
       Integer num=Integer.valueOf(numFunc);
       Integer ced=Integer.valueOf(cedula);
       Integer horas=Integer.valueOf(baseHoras);
       Integer horaria=Integer.valueOf(baseHoraria);
       
           f.setCodFunc(num);
           f.setApellido1(apellidoUno);
           f.setApellido2(apellidoDos);
           f.setNombre1(nombreUno);
           f.setNombre2(nombreDos);
           f.setDireccion(direccion);
           f.setLocalidad(localidad);
           f.setDepartamento(depto);
           f.setTelefono(telefono);
           f.setCelular(celular);
           f.setCedula(ced);
           f.setCredencial(credencial);
           f.setFechaNac(fechaNac);
           f.setEstadoCivil(estado);
           f.setFechaIngreso(fechaIngreso);
           f.setFechaEgreso(fechaEgreso);
           f.setSexo(sexo);
           f.setIniciales(iniciales);
           f.setCargo(cargo);
           f.setVigenciaCargo(vigenciaCargo);
           f.setSueldoCargo(sueldo);
           f.setCentroCosto(centro);
           f.setBaseHoraria(horaria);
           f.setBaseHoras(horas);
           f.setLugarTrabajo(sucursal);
           f.setSns(sns);
           f.setBanco(banco);
           f.setCuenta(numeroCuenta);
           f.setTipoCuenta(cuenta);
           f.setAfap(afap);
           f.setHorarios(listaHorarios);
           f.setVencimientoCarne(vencimientoCarne);
           f.setCodigoDesvinc(cod);
           alta=this.pers.modFuncionario(f,fv);
       
       return alta;

    }
    
     public boolean modFuncionarioSecretaria(Funcionario f) throws SQLException {
       
       Boolean alta=false;
      
           alta=this.pers.modFuncionarioSecretaria(f);
       
       return alta;

    }
    
    public ArrayList<Funcionario> vencimientoCarne() throws ClassNotFoundException, SQLException{
      return  this.pers.vencimientoCarne();
    }
    public ArrayList<Funcionario> listadoFuncionariosActivos(String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionariosActivos(filtro);
    }  
    public ArrayList<Funcionario> listadoFuncionarios(String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionarios(filtro);
    }
    public ArrayList<Funcionario> listadoFuncionariosInactivos(String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionariosInactivos(filtro);
    }
    public ArrayList<Funcionario> listadoFuncionariosActivosPorSuc(Integer cod,String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionariosActivosPorSuc(cod,filtro);
    }
    public ArrayList<Funcionario> listadoFuncionariosInactivosPorSuc(Integer cod, String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionariosInactivosPorSuc(cod,filtro);
    }
    public ArrayList<Funcionario> listadoFuncionariosPorSuc(Integer cod, String filtro) throws ClassNotFoundException, SQLException{
        return this.pers.listarFuncionariosPorSuc(cod,filtro);
    }

    public ArrayList<Funcionario> listadoVencidos() throws ClassNotFoundException, SQLException {
        return  this.pers.listadoVencidos();
    }
    public ArrayList<Licencia> listadoLicencia(String str) throws ClassNotFoundException, SQLException {
        Integer a√±o=Integer.valueOf(str)+1;
        return  this.pers.listarLicencia(a√±o);
    }
    public ArrayList<Licencia> licenciaPorCod(String codigo)throws BDExcepcion {
        Integer cod=Integer.valueOf(codigo);
        return  this.pers.licenciaPorCod(cod);
    }
    public Licencia Licencia(String codigo)throws BDExcepcion, ParseException{
        Integer cod=Integer.valueOf(codigo);
        return  this.pers.licencia(cod,this.calcular1());
    }
    public Licencia LicenciaA√±o(String codigo,String a√±o)throws BDExcepcion, ParseException{
        Integer cod=Integer.valueOf(codigo);
        return  this.pers.licencia(cod,this.calcular2(a√±o));
    }
    public Funcionario funcParcial(String codigo) throws BDExcepcion{
        Integer cod=Integer.valueOf(codigo);
        return this.pers.funcionarioParcial(cod);
    }
    
     public Funcionario funcParcialTodos(String codigo) throws BDExcepcion{
        Integer cod=Integer.valueOf(codigo);
        return this.pers.funcionarioParcialTodos(cod);
    }
    
    public Funcionario funcVale(Integer codigo,Connection cnn) throws ClassNotFoundException, SQLException{
        return this.pers.funcionarioVale(codigo,cnn);
    }
    public Funcionario funcBasico(String codigo) throws ClassNotFoundException, SQLException{
        Integer cod=Integer.valueOf(codigo);
        return this.pers.funcionarioBasico(cod);
    }
    public boolean insertarLicencia() throws SQLException, ClassNotFoundException, ParseException{
        Connection cnn=null;
        cnn=conexion.Cadena();
        ArrayList<Licencia> lista=this.calculaLicencia(cnn);
        int i=0;
        boolean alta=false;
        if(this.pers.eliminarLicencia(this.calcular(),cnn)){
        ArrayList<Licencia> listado=this.listadoLicencia(this.obtenerA√±o1(this.calcular3()));
        if(listado.isEmpty()){
            for(i=0;i<lista.size();i++){
                this.pers.insertarLicencia(lista.get(i),cnn);
            }
        }
        else{
               for(i=0;i<lista.size();i++){
                     if(this.estaEnLicencia(listado, lista.get(i))){
                            this.pers.actualizarLicenciaFechaCargada(lista.get(i));
                            
                        }
                        else{
                          
                            this.pers.insertarLicencia(lista.get(i),cnn);
                        }
                     
                }
            
        }
     
        if(i==lista.size()){
        alta=true;
        }
        
        }
        if(cnn!=null){
            cnn.close();
        }
        return alta;
    }
    
    private boolean estaEnLicencia(ArrayList<Licencia> listado,Licencia lic){
        boolean esta=false;
        int i=0;
        while(i<listado.size()&&!esta){
              if(listado.get(i).getFuncionario().getCodFunc().equals(lic.getFuncionario().getCodFunc())&& listado.get(i).getA√±o().equals(lic.getA√±o())){
                  esta=true;
              }
               i++;             
            }
        return esta;
    }
    
    public ArrayList<Licencia> cargaComboLicencia(String cod)throws BDExcepcion{
        Integer c=Integer.valueOf(cod);
        return this.pers.cargaComboLicencia(c);
    }
    public ArrayList<Licencia> cargaComboLicenciaPasado(String cod)throws BDExcepcion{
        Integer c=Integer.valueOf(cod);
        return this.pers.cargaComboLicenciaPasado(c);
    }
    
    ///MODIFICACIONES LICENCIA///
    public Licencia licenciaActualFunc(Integer cod) throws BDExcepcion{
        
        return this.pers.licenciaActualFunc(cod);
        
    }
    
    public boolean actualizarLicenciaActual(String dias, Licencia l,MovimientoLicencia m) throws ClassNotFoundException, SQLException {
        Integer d=Integer.valueOf(dias);
        Date hoy=new Date();
        MovimientoLicencia Mov=new MovimientoLicencia();
                 Mov.setA√±oSaldo(l.getA√±o()+1);
                 Mov.setDiasTomados(d*-1);
                 Mov.setFechaIni(m.getFechaIni());
                 Mov.setFechaFin(m.getFechaFin());
                 Mov.setReferencia(m.getReferencia());
                 Mov.setFechaMovimiento(hoy);
                 Mov.setFuncionario(l.getFuncionario());
                 Mov.setSaldoA√±o(l.getSaldo());
                 Mov.setSaldoPos(l.getSaldo()+d);
                 Mov.setTipoLic(10);
                 return this.pers.insertarMovLicencia(Mov);
    }
    
    
    
    ///------------------------------///
    
    public boolean insertarFeriado(String desc, Date fecha,Integer tipo) throws ClassNotFoundException, SQLException{
        Feriado f=new Feriado();
        f.setFecha(fecha);
        f.setAnio(Integer.valueOf(this.obtenerA√±o1(fecha)));
        f.setTipo(tipo);
        f.setDescripcion(desc);
        return this.pers.insertarFeriado(f);
    }
    public boolean modificarFeriado(Feriado f) throws ClassNotFoundException, SQLException {
    f.setAnio(Integer.valueOf(this.obtenerA√±o1(f.getFecha())));
    return this.pers.modificarFeriado(f);
    }
      
    public boolean eliminarFeriado(Feriado f) throws ClassNotFoundException, SQLException {
        return this.pers.eliminarFeriado(f);
    } 
    
    public ArrayList<Feriado> listarFeriados(Integer anio) throws SQLException, ClassNotFoundException, ParseException{
        Date d=new Date();
        Integer a√±o=Integer.valueOf(this.obtenerA√±o1(d));
        return this.pers.listarFeriados(anio);
    }
    public ArrayList<String> cargaComboFeriadoA√±osDistintos() throws ClassNotFoundException, SQLException{
        return this.pers.cargaComboFeriadoA√±osDistintos();
    }
    //********CALCULO DIAS DE LICENCIA*********//
    private Date calcular() throws ParseException{
        Date d=new Date();
        String t=this.obtenerA√±o1(d);
        String s="31/12/"+t;
        Date ult=this.stringADate(s);
        return ult;
    }
    private Date calcular1() throws ParseException{
        Date d=new Date();
        String t=this.obtenerA√±o(d);
        String s="31/12/"+t;
        Date ult=this.stringADate(s);
        return ult;
    }
    private Date calcular2(String a√±o) throws ParseException{
        String s="31/12/"+a√±o;
        Date ult=this.stringADate(s);
        return ult;
    }
    private Date calcular3() throws ParseException{
        Date d=new Date();
        String t=this.obtenerA√±o2(d);
        String s="31/12/"+t;
        Date ult=this.stringADate(s);
        return ult;
    }
    private String obtenerA√±o1(Date d){
        
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(d);
        String t=String.valueOf(calendar.get(Calendar.YEAR));
        return t;
    }
    private String obtenerA√±o2(Date d){
        
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(d);
        String t=String.valueOf(calendar.get(Calendar.YEAR));
        return t;
    }
    private String obtenerA√±o(Date d){
        
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(d);
        String t=String.valueOf(calendar.get(Calendar.YEAR)-1);
        return t;
    }
    private String obtenerMes(Date d){
        
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(d);
        String t=String.valueOf(calendar.get(Calendar.MONTH));
        return t;
    }
    private String obtenerDia(Date d){
        
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(d);
        String t=String.valueOf(calendar.get(Calendar.DAY_OF_MONTH));
        return t;
      }
    private Date stringADate(String s) throws ParseException{
        SimpleDateFormat formatter = new SimpleDateFormat("dd/MM/yyyy");
            Date date = formatter.parse(s);
        return date;
    }
    
    public ArrayList<Licencia> calculaLicencia(Connection cnn) throws ParseException, ClassNotFoundException, SQLException{
        Integer a√±osTrab=null;
        Integer diasGenerados=null;
        Date d=this.calcular();//fecha de calculo 31/12/yyyy
        Date h=new Date();//fecha de hoy
        Calendar c = Calendar.getInstance(); 
//        c.setTime(d); 
//        c.add(Calendar.DATE, -365);
//        d = c.getTime();
        Date r=new Date();
        String a√±o=this.obtenerA√±o(r);
        ArrayList<Funcionario> lista=this.pers.listarFuncionariosActivosParaLic();
        ArrayList<Licencia> lice=new ArrayList<>();
        for(int i=0;i<lista.size();i++){
            Licencia l=new Licencia();
           a√±osTrab=this.calcularA√±osTrabajados(d,lista.get(i).getFechaIngreso());
           if(a√±osTrab>=5){
              diasGenerados=(a√±osTrab/4)+20;
           }
           else if(a√±osTrab>0){
               diasGenerados=20;
           }
           else{
               diasGenerados=this.calculoTardio(lista.get(i).getFechaIngreso(), d);
           }
           
           l.setDiasGenerados(diasGenerados);
           l.setFuncionario(lista.get(i));
           Date p=new Date();
           l.setA√±o(Integer.valueOf(this.obtenerA√±o1(p))+1);
           //l.setA√±o(2018);
           l.setFechaGen(d);
           if(l.getFuncionario().getCodFunc()==2140){
               String rt="";
           }
           l.setDiasDescuento(this.calcularDiasDescuento(lista.get(i),d,cnn,diasGenerados));
           lice.add(l);
        }
      return lice;
    }
    
    private Integer calcularDiasDescuento(Funcionario f,Date fechaLiq,Connection cnn,Integer diasGenerados){
        Integer faltas=0;
        try {
            Date fechaAux=this.obtieneFechaAux(f,fechaLiq);
            Calendar liq = Calendar.getInstance();
            liq.setTime(fechaLiq);
            faltas=this.pers.obtenerFaltas(f,liq.get(Calendar.YEAR),fechaAux,cnn);
            
        } catch (SQLException ex) {
            Logger.getLogger(LogFuncionario.class.getName()).log(Level.SEVERE, null, ex);
        }
        return this.calculoDiasDescuento(faltas, diasGenerados);
    }
    
    private Integer calculoDiasDescuento(Integer faltas,Integer diasGenerados){
        Integer retorno = ((faltas*diasGenerados)/360);
        return retorno;
    }
    
    private Date obtieneFechaAux(Funcionario f,Date fechaLiq){
        Date fechaAux=f.getFechaIngreso();
        Calendar aux = Calendar.getInstance(); 
        aux.setTime(fechaAux); 
        Calendar liq = Calendar.getInstance(); 
        liq.setTime(fechaLiq); 
        if(aux.get(Calendar.YEAR)==liq.get(Calendar.YEAR)){
            fechaAux=this.buscoUltimoDiaMes(fechaAux);
        }
        
        return fechaAux;
    }
    
    private Date buscoUltimoDiaMes(Date fechaAux){
        Calendar aux = Calendar.getInstance(); 
        aux.setTime(fechaAux);
        Integer dia=0;
        switch(aux.get(Calendar.MONTH)){
            case 1: case 3: case 5: case 7: case 8: case 10: case 12:
                dia=31;
            break;
            case 2:
                if(aux.get(Calendar.YEAR)%4==0){
                    dia=29;
                }
                else{
                    dia=28;
                }
            break;
            case 4: case 6: case 9: case 11:
                dia=30;
            break;
            default:
            break;
        }
        aux.set(Calendar.DAY_OF_MONTH,dia);
        return aux.getTime();
    }
    public Licencia calculaLicenciaIndividual(Integer cod, Date fecha)throws BDExcepcion, ParseException{
        Integer a√±osTrab=null;
        Integer diasGenerados=null;
        Licencia l=null;
        Date fechaAnt=this.calcular1();
        Funcionario f=this.pers.funcionarioParcial(cod);
        if(f!=null){       
           l=new Licencia();
           a√±osTrab=this.calcularA√±osTrabajados(fechaAnt,f.getFechaIngreso());
           if(a√±osTrab>=5){
              diasGenerados=(a√±osTrab/4)+20;
           }
           else if(a√±osTrab>0){
               diasGenerados=20;
           }
           else{
               diasGenerados=this.calculoTardio(f.getFechaIngreso(), fechaAnt);
           }
           diasGenerados=this.prorrateo(fecha,diasGenerados);
           
           l.setDiasGenerados(diasGenerados);
           l.setFuncionario(f);
           Date p=new Date();
           l.setFechaGen(fecha);
           l.setA√±o(Integer.valueOf(this.obtenerA√±o(fecha))+1);
        }
        
        return l;
    }

    private Integer calcularA√±osTrabajados(Date d, Date fechaIngreso) {
     Date x=d;
     Calendar c = Calendar.getInstance(); 
     c.setTime(x); 
     c.add(Calendar.DATE, 2);
     x = c.getTime();
     Integer a√±os=Integer.valueOf(this.obtenerA√±o(x))-Integer.valueOf(this.obtenerA√±o(fechaIngreso));
     if(Integer.valueOf(this.obtenerMes(x))<Integer.valueOf(this.obtenerMes(fechaIngreso))){
         a√±os=a√±os-1;
     }
     else if(Integer.valueOf(this.obtenerMes(x))==Integer.valueOf(this.obtenerMes(fechaIngreso))){
                if(Integer.valueOf(this.obtenerDia(x))<Integer.valueOf(this.obtenerDia(fechaIngreso))){
                    a√±os=a√±os-1;
                }
     }
     return a√±os;
    }
    
 
    private int calculoTardio(Date fechaIngreso, Date d) {
        long fin=0;
        Integer dias=this.diferenciaDeDias(d,fechaIngreso);
        Double auxiliar = (dias * 0.05479);
        
        DecimalFormat df = new DecimalFormat("####.00");
        String aux = df.format(auxiliar);
        String aux2=this.cambiarPunto(aux);
        Double a=Double.parseDouble(aux2);
        Integer b=a.intValue();
        Double s=a-b;
        if(!s.equals(0)){
            Double redondeo=1-s;
            fin=Math.round(auxiliar+redondeo);
        }        
        return (int)fin;
    }

    private Integer diferenciaDeDias(Date d, Date fechaIngreso) {
     SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
     int dias=(int) ((d.getTime()-fechaIngreso.getTime())/86400000);
     return dias;
    }

    private String cambiarPunto(String aux) {
        
        String replace = aux.replace(",", ".");
        return replace;
    }

    public boolean actualizarLic(Date fechaIni, Date fechaFin,Licencia lic) throws BDExcepcion{
             lic.setSaldo(lic.getSaldo()-lic.getDiasDescuento());
        return this.pers.actualizarLicencia(fechaIni,fechaFin,lic);
    }

    public boolean insertarMovLicencia(Date ini, Date fin, Integer saldo, Integer diasTomar, Date hoy, Integer a√±oSacar, Funcionario Func, Integer saldoPos,Integer tipoLic,Long marcaId) throws ClassNotFoundException, SQLException {
            MovimientoLicencia Mov=new MovimientoLicencia();
            Mov.setA√±oSaldo(a√±oSacar);
            Mov.setDiasTomados(diasTomar);
            Mov.setFechaFin(fin);
            Mov.setFechaIni(ini);
            Mov.setFechaMovimiento(hoy);
            Mov.setFuncionario(Func);
            Mov.setSaldoPos(saldoPos);
            Mov.setSaldoA√±o(saldo);
            Mov.setTipoLic(tipoLic);
            Mov.setReferencia(0);
            Mov.setMarcaId(marcaId);
           return this.pers.insertarMovLicencia(Mov);
    }
    
    public MovimientoLicencia consultaAdelantadoDos(String codFunc)throws BDExcepcion{
         Integer cod=Integer.valueOf(codFunc);
           Date fecha=new Date();
           Integer a√±o=Integer.valueOf(this.obtenerA√±o(fecha));
           a√±o=a√±o+2;
           Licencia l=this.pers.licenciaActualFunc(cod);
           return pers.consultaAdelantado(cod,a√±o);
    }
    
    public MovimientoLicencia consultaAdelantado(String codFunc)throws BDExcepcion{
           Integer cod=Integer.valueOf(codFunc);
           Date fecha=new Date();
           Integer a√±o=Integer.valueOf(this.obtenerA√±o(fecha));
           a√±o=a√±o+2;
           Licencia l=this.pers.licenciaActualFunc(cod);
           if(l!=null){
               if(l.getFechaIni()!=null){
                    if(l.getFechaIni().before(fecha)){
                        if(this.convertirFecha(fecha).equals(this.convertirFecha(l.getFechaIni()))){
                        return pers.consultaAdelantado(cod,a√±o);
                        }
                        else{
                            return pers.consultaAdelantado(cod,a√±o);
                        }
                    }
                    else{
                        return pers.consultaAdelantado(cod,a√±o-1);
                    }
               }
               else{
                   MovimientoLicencia lic=new MovimientoLicencia();
                   return lic;
               }
           }
           else{
               return null;
               
           }
    }
   private String convertirFecha(Date fecha){
   String str=null;
        if(fecha!=null){
         SimpleDateFormat sdf=new SimpleDateFormat("dd/MM/yyyy"); 
         str= sdf.format(fecha);
    }
        return str;
   }

    public boolean insertarLicAdelantada(Integer a√±o, Date ini, Date fin, Integer diasTomar, Funcionario func,Integer referencia,Long id) throws ClassNotFoundException, SQLException {
         MovimientoLicencia lic=new MovimientoLicencia();
                Date d=new Date();
                lic.setA√±oSaldo(a√±o);
                lic.setDiasTomados(diasTomar);
                lic.setFechaFin(fin);
                lic.setFechaIni(ini);
                lic.setFechaMovimiento(d);
                lic.setFuncionario(func);
                lic.setReferencia(referencia);
               
                return pers.insertarLicAdelantada(lic,id);
    }

    public ArrayList<MovimientoLicencia> listarLicAdelantada(String codigo, MovimientoLicencia mov)throws BDExcepcion{
         Integer cod=null;
         if(!codigo.equals("")){
         cod=Integer.valueOf(codigo);
         }
         return pers.listarLicAdelantada(cod,mov);
   }

    public ArrayList<MovimientoLicencia> movimientoLic(String cod,MovimientoLicencia mov) throws BDExcepcion{
         
         Integer codigo=null;
         if(!cod.equals("")){
         codigo=Integer.valueOf(cod);
         }
         return pers.movimientoLic(codigo,mov);
    }
    public ArrayList<MovimientoLicencia> ultimoMovimiento(String cod,Integer tipo, Integer anio) throws BDExcepcion{
        Integer codigo=null;
        Integer tip=null;
        ArrayList<MovimientoLicencia> mov=null;
         if(!cod.equals("")){
            codigo=Integer.valueOf(cod);
            mov=this.pers.ultimoMovimiento(codigo, tipo, anio+1);

         }
         return mov;
    }
    
    public ArrayList<MovimientoLicencia> comboMovimientoA√±oLic() throws ClassNotFoundException, SQLException{
        return this.pers.comboMovimientoA√±oLic();
    }
    
    
    public ArrayList<String> cargaComboLicA√±osDistintos() throws ClassNotFoundException, SQLException {
        return this.pers.cargaComboLicA√±osDistintos();
    }

    public ArrayList<Feriado> listarTodosFeriados() throws ClassNotFoundException, SQLException {
        return this.pers.listarTodosFeriados();
    }
     public ArrayList<Feriado> listarFeriadosRango(Date desde,Date hasta) throws ClassNotFoundException, SQLException {
        return this.pers.listarFeriadosRango(desde,hasta);
    }

    public ArrayList<Licencia> licenciaAnteriorFunc(Integer codFunc) throws BDExcepcion{
        
        return this.pers.licenciaAnteriorFunc(codFunc);
    }

    public Integer saldoLicenciaCodigo(String codFunc, Integer cod) throws ClassNotFoundException, SQLException {
        Integer codF=Integer.valueOf(codFunc);
        return this.pers.saldoLicenciaCodigo(codF, cod);
    }

 
 //PAQUETE CALCULA FECHA FIN AUTOMATICO//
    public Date obtieneFechaFin(Date fechaIni, Integer dias,ArrayList<Horario>horarios){
      Calendar calendar = Calendar.getInstance();
      calendar.setTime(fechaIni); 
      calendar.add(Calendar.DAY_OF_YEAR, dias-1);  
      Date fechaFinParcial=calendar.getTime(); 
      Integer dif=this.diferenciaDias(fechaIni, fechaFinParcial, horarios);
      calendar.setTime(fechaFinParcial); 
      calendar.add(Calendar.DAY_OF_YEAR, dif);  
      Date fechaFin=calendar.getTime();
      GregorianCalendar cal = new GregorianCalendar();
      cal.setTime(fechaFin);
      
      Integer domingos=this.diferenciaDias(fechaIni, cal.getTime(), horarios);
      Integer difFinal=domingos-dif;
      cal.add(Calendar.DAY_OF_YEAR, difFinal);
      Integer domingos2=this.diferenciaDias(fechaIni, cal.getTime(), horarios);      
      difFinal=domingos2-domingos;
      cal.add(Calendar.DAY_OF_YEAR, difFinal);
      
//      if(cal.get(Calendar.DAY_OF_WEEK)==1){
//          cal.add(Calendar.DAY_OF_YEAR, -1);
//      }
      Date retorno=cal.getTime();
      return retorno;
    }
    
    private Integer diferenciaDias(Date fechaIni, Date fechaFin,ArrayList<Horario>horarios) {
        Integer real=0;
        int dias=(int) ((fechaFin.getTime()-fechaIni.getTime())/86400000);
        dias+=1;
 	Integer domingos=this.obtieneDomingoySabado(fechaIni, fechaFin,horarios);
        Integer feriados=this.compararFechas(fechaIni, fechaFin).size();
        real=domingos+feriados;
        
        return real;
    }
    
    private Integer obtieneDomingoySabado(Date fechaIni, Date fechaFin,ArrayList<Horario>horarios){
    Integer contador=0;
    Calendar c1 = Calendar.getInstance();
    c1.setTime(fechaIni);
    Calendar c2 = Calendar.getInstance();
    c2.setTime(fechaFin);
    ArrayList<Date> listaFechas = new ArrayList<Date>();
    boolean Domingo=this.diaEsta(horarios,"DOMINGO");
    //boolean Sabado=this.diaEsta(horarios,"SABADO");
    
    while (!c1.after(c2)) {
        listaFechas.add(c1.getTime());
        c1.add(Calendar.DAY_OF_MONTH, 1);
        
    }
    
    for (Iterator<Date> it = listaFechas.iterator(); it.hasNext();) {
          Date date = it.next();
          GregorianCalendar cal = new GregorianCalendar();
          cal.setTime(date);
          
          if(!Domingo){
            if(cal.get(Calendar.DAY_OF_WEEK)==1){
                  contador++;
            }	
          }
//          if(!Sabado){
//            if(cal.get(Calendar.DAY_OF_WEEK)==7){
//                  contador++;
//          }
//       }
       
    }
     return contador;
  }
   
    private ArrayList<Feriado> compararFechas(Date fechaIni, Date fechaFin) {
        Integer dias=0;
        ArrayList<Feriado> aux=new ArrayList<>();
        
        for(Feriado f:this.listaFeriados){
            if((fechaIni.equals(f.getFecha())||fechaIni.before(f.getFecha()))&& (fechaFin.equals(f.getFecha())||fechaFin.after(f.getFecha()))){
                Calendar cal = Calendar.getInstance();
                cal.setTime(f.getFecha());
                if(cal.get(Calendar.DAY_OF_WEEK)!=1){
                aux.add(f);
                }
            }
        }
        
        return aux;
    }
    
    private boolean diaEsta(ArrayList<Horario> horarios, String dia) {
        boolean esta=false;
        int i=0;
        while(i<horarios.size()&&!esta){
            if(horarios.get(i).getDescripcion().equals(dia)){
                esta=true;
            }
            i++;
        }
         return esta;
    }    
    
   public ArrayList<Fallecimiento> cargaComboFalle() throws ClassNotFoundException, SQLException {
        return this.pers.cargaComboFalle();
    }

    public boolean existeCodigoDesvinc(Integer cod) throws ClassNotFoundException, SQLException {
        return this.pers.existeCodigoDesvinc(cod);
    }
    
    public boolean CodigoDesvincUsado(Integer cod) throws ClassNotFoundException, SQLException {
        return this.pers.CodigoDesvincUsado(cod);
    }

    public boolean altaCodigoDesvinc(CodigoDesvinc c) throws SQLException {
            return this.pers.altaCodigoDesvinc(c);
    }

    public Integer modificaCodDesvinc(Integer idVieja, CodigoDesvinc codi) throws SQLException {
       return this.pers.modificaCodDesvinc(idVieja,codi);
    }

    public boolean bajaCodigoDesvinc(Integer id) throws SQLException {
         return this.pers.bajaCodigoDesvinc(id);
    }

public String fechaLiquidacion() throws ClassNotFoundException, SQLException{
    return this.pers.fechaLiquidacion();
}
  
public ArrayList<Funcionario> listarFuncionariosActivosLike(String filtro) throws ClassNotFoundException, SQLException{
    return this.pers.listarFuncionariosActivosLike(filtro);
}
   
        
///DECLARACIONES JURADAS

public ArrayList<String> cargoComboDocumento() throws ClassNotFoundException, SQLException{
    cn = conexion.Cadena();
   return this.c.cargoComboDocumento(cn);
}
public ArrayList<String> cargoComboPais(){
    return this.c.cargocomboPais(cn);
}
public ArrayList<String> cargoComboNacionalidad(){
    return this.c.cargocomboNacionalidad(cn);
}
public ArrayList<Relacion> cargoComboRelacion(){
    return this.c.cargocomboRelacion(cn);
}
public ArrayList<String> cargoComboFondo() throws SQLException{
      ArrayList<String> caja= this.c.cargocomboCaja(cn);
   if(cn!=null){
        cn.close();
    } 
   return caja;
}

public Declaracion cargoDeclaracion(Integer codFunc){
    return this.pers.cargoDeclaracion(codFunc);
}

public ArrayList<PersonasACargo> cargoPeronas(Integer codFunc){
    return this.pers.cargoPersonas(codFunc);
}    

//    public boolean actualizaPersonasAcargo(String tipoDoc, String numDoc, String pais, Date fecha, String nacional, Character sexo, Character relacion, String salud, Integer atrib, Integer discapacidad, String nombreUno, String nombreDos, String apellidoUno, String apellidoDos, PersonasACargo pe) {
//        boolean ret=false;
//        PersonasACargo p = new PersonasACargo();
//        p.setApellidoDos(apellidoDos);
//        p.setApellidoUno(apellidoUno);
//        p.setDiscapacidad(discapacidad);
//        p.setFecha_nac(fecha);
//        p.setNacionalidad(nacional);
//        p.setNombreDos(nombreDos);
//        p.setNombreUno(nombreUno);
//        p.setNroDoc(numDoc);
//        p.setPais(pais);
//        p.setPjedist(atrib);
//        p.setRelacion(relacion);
//        p.setSexo(sexo);
//        p.setSistSalud(salud);
//        p.setTipoDoc(tipoDoc);
//        
//        if(this.pers.atualizaPersonasAcargo(p,pe)){
//            ret=true;
//        }
//        return ret;
//    }

    public boolean ingresoDeclaracion(Integer codFunc, String tipoDoc, String nroDoc, String pais, String strVigMes, String strVigA√±o, String strCatcjpu, String strReint, String fondo, String strAdicional, String strMinimo, Date fechaRecep, String familiar, String tipoDocCony, String nroDocCony, String paisCony, String apeUnoCony, String apeDosCony, String nomUnoCony, String nomDosCony, Date fechaNacCony, String nacCony, String sexoCony, ArrayList<PersonasACargo> lista) throws BDExcepcion {
        Declaracion d = new Declaracion();
        
        if(strAdicional!=null){
            if(strAdicional.equals("NO")){
            d.setAdicionalcjpu(0);
            }
            else{
            d.setAdicionalcjpu(1);    
            }
        }
        else{
            d.setAdicionalcjpu(null);    
        }
        
        d.setApellidoDosConyu(apeDosCony);
        d.setApellidoUnoConyu(apeUnoCony);
        d.setCatcjpu(Integer.valueOf(strCatcjpu));
        d.setCodFunc(codFunc);
        
        if(familiar!=null){
            if(familiar.equals("NO")){
                 d.setFamiliar(0);
            }
            else{
             d.setFamiliar(1);
            }
        }
        else{
             d.setFamiliar(null);
        }
       
        d.setFechaNacConyu(fechaNacCony);
        d.setFechaRecepcion(fechaRecep);
        d.setFondosolcjpu(fondo);
        
        if(strMinimo!=null){
            if(strMinimo.equals("NO")){
            d.setMinimoimp(0);
            }
            else{
            d.setMinimoimp(1);
            }
        }
        else{
        d.setMinimoimp(null);
        }
        
        d.setNacionalConyu(nacCony);
        d.setNombreDosConyu(nomDosCony);
        d.setNombreUnoConyu(nomUnoCony);
        d.setNroDoc(nroDoc);
        d.setNroDocConyu(nroDocCony);
        d.setPais(pais);
        d.setPaisConyu(paisCony);
        if(lista!=null){
        d.setPersonasACargo(lista.size());
        }
        else{
            d.setPersonasACargo(0);
        }
        d.setReintcjpu(Double.valueOf(strReint));
        if(sexoCony!=null){
            if(sexoCony.equals("MASCULINO")){
            d.setSexoConyu('M');
            }
            else{
            d.setSexoConyu('F');    
            }
        }
        else{
            d.setSexoConyu(null);
        }
        d.setTipoDoc(tipoDoc);
        d.setTipoDocConyu(tipoDocCony);
        Integer vig = Integer.valueOf(strVigA√±o+strVigMes);
        d.setVigencia(vig);
        
        
        return this.pers.ingresoDeclaracion(d,lista);
            
    }

    public boolean eliminarDeclaracion(Funcionario f) {
        boolean retorno = false;
        try {
            cn = conexion.Cadena();
            cn.setAutoCommit(false);
            if(this.pers.borrarDeclaracion(f.getCodFunc(), cn)==1){
                if(this.pers.borrarPersonasACargo(f.getCodFunc(), cn)>=1){ 
                    retorno=true;
                }
            }
            cn.commit();
            if(cn!=null){
                cn.close();
            }
          
        } catch (ClassNotFoundException ex) {
            Logger.getLogger(LogFuncionario.class.getName()).log(Level.SEVERE, null, ex);
        } catch (SQLException ex) {
            Logger.getLogger(LogFuncionario.class.getName()).log(Level.SEVERE, null, ex);
        }
          return retorno;
    }

    public ArrayList<CodigoBcu> cargaComboBcu() {
         return c.cargaComboBcu();
    }
    
    public ArrayList<Funcionario> listadoSueldo() throws SQLException, ClassNotFoundException{
        return this.pers.listadoSueldo();
    }

    public Integer actualizaSalarios(ArrayList<Funcionario> funcionarios,String antiguedad,String porcentaje,Integer tipo) {
        return this.pers.actualizaSalario(funcionarios,antiguedad,porcentaje,tipo);
    }
    
    public boolean actualizaParametros(String valorNuevo, String valorViejo, String nombre) throws BDExcepcion{
        return this.pers.actualizaParametros(valorNuevo, valorViejo, nombre);
    }
    
    public ArrayList<Parametro> cargoParametros() throws BDExcepcion{
        return this.pers.cargaParametros();
    }
    
    public String cargoParametro(String nombre) throws BDExcepcion, ClassNotFoundException, SQLException{
        return this.pers.cargoParametro(nombre); 
    }
    
    public boolean actualizaParametro(String valor, String nombre) throws BDExcepcion{
        return this.pers.actualizaParametro(valor, nombre);
    }
    
    public String valorDeAntiguedad() throws ClassNotFoundException, SQLException{
        return this.pers.valorDeAntiguedad();
    }

    public boolean borrarLicAdelantada(Long id, Integer funCod, Integer codigo) {
        return this.pers.borrarLicAdelantada(id,funCod,codigo);
    }

    public Integer obtieneA√±oSaldo(Long id, Integer funCod, Integer codigo) throws ClassNotFoundException, SQLException {
        return this.pers.obtieneA√±oSaldo(id,funCod,codigo);
    }

    private Integer prorrateo(Date fecha, Integer diasGenerados) throws ParseException {
        Integer retorno=0;
        Long ret;
        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd");
        Date fechaInicial=dateFormat.parse(this.obtenerA√±o1(fecha)+"-01-01");
	Integer dias=(int) ((fecha.getTime()-fechaInicial.getTime())/86400000);
        
        
        double d=Double.valueOf(dias*diasGenerados)/360;
        ret=(long) Math.ceil(d);
        
        retorno=ret.intValue();
        return retorno;
    }

    public Integer actualizoParametros(ArrayList<Parametro> parametros) throws BDExcepcion {
        Integer total=0;
        for(Parametro p:parametros){
            if(p.getValorNuevo()!=null){
                if(this.pers.actualizaParametros(p.getValorNuevo().trim(), p.getValor().trim(), p.getNombre().trim())){
                    total++;
                }
            }
        }
        return total;
        
    }

    public ArrayList<Funcionario> listadoFuncionariosActivosReLiq() throws ClassNotFoundException, SQLException {
        return this.pers.listarFuncionariosActivosReLiq();
    }

    public Date fechaLiquidacionEnLiq() throws BDExcepcion {
       return this.pers.fechaLiquidacionEnLiq();
    }

    public boolean fechaLiquidacionHistorica(String fechaLiq) throws BDExcepcion {
       return this.pers.fechaLiquidacionHistorica(fechaLiq);
    }

    
}
